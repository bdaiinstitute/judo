name: Build and Publish to PyPI

# triggered manually only
on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  check-if-codeowner:
    runs-on: ubuntu-latest
    outputs:
      is_owner: ${{ steps.check.outputs.is_owner }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check actor
        id: check
        run: |
          actor=${{ github.actor }}
          if grep -qE "(^|[[:space:]])@$actor([[:space:]]|$)" .github/CODEOWNERS; then
            echo "is_owner=true" >> $GITHUB_OUTPUT
            echo "Actor is code owner"
          else
            echo "is_owner=false" >> $GITHUB_OUTPUT
            echo "Actor is not a code owner"
          fi

  build:
    runs-on: ubuntu-22.04
    needs: check-if-codeowner
    if: needs.check-if-codeowner.outputs.is_owner == 'true'
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']
        include:
          - python-version: '3.10'
            pixi-env: test-py310
            python-tag: cp310
          - python-version: '3.11'
            pixi-env: test-py311
            python-tag: cp311
          - python-version: '3.12'
            pixi-env: test-py312
            python-tag: cp312
          - python-version: '3.13'
            pixi-env: test-py313
            python-tag: cp313

    steps:
      - uses: actions/checkout@v6

      - uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: latest
          environments: ${{ matrix.pixi-env }}
          cache: true

      - name: Build mujoco_extensions
        run: pixi run -e ${{ matrix.pixi-env }} build-mujoco-ext

      - name: Build wheel
        run: pixi run -e ${{ matrix.pixi-env }} python -m build --wheel --outdir dist

      - name: Tag wheel as platform-specific
        run: |
          pixi run -e ${{ matrix.pixi-env }} wheel tags \
            --python-tag ${{ matrix.python-tag }} \
            --abi-tag ${{ matrix.python-tag }} \
            --platform-tag manylinux_2_35_x86_64 \
            --remove dist/*.whl

      - name: Verify package
        run: pixi run -e ${{ matrix.pixi-env }} twine check dist/*.whl

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v6
        with:
          name: wheel-${{ matrix.python-version }}
          path: dist/*.whl
          retention-days: 7

  publish:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: wheel-*
          path: dist
          merge-multiple: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          skip-existing: true
